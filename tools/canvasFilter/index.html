<!DOCTYPE html>
<html>
<head>
  <title>CanvasFilter|Beta</title>
</head>
<body>
	<input type="file" id="fileInput" accept="image/*">
	<canvas id="original"></canvas>
	<canvas id="filter"></canvas>
	<br>
	<br>
	<input type='button' id='applyGrayScale' value='applyGrayScale'/>
	<input type='button' id='applyFilter2' value='applyFilter2'/>
	<script src='/rsrc/js/autoload.js'></script>
	<script>
		class Filter{
			constructor({canvas=null}={}){
				if(!canvas)
					throw new Error("canvas required");
				
				if(!(canvas instanceof HTMLElement && canvas.tagName=='CANVAS'))
					throw new Error("invalid canvas");
				
				this.canvas=canvas;
				this.ctx=canvas.getContext("2d");
			}

			applyGrayScaleFilter(){
				const canvas=this.canvas;
				const ctx=canvas.getContext("2d");
				const imageData=ctx.getImageData(0,0,canvas.width,canvas.height);
				const data = imageData.data;
				for (let i=0;i<data.length;i+=4) {
					const gray = (data[i]+data[i+1]+data[i+2])/3;
					data[i]=gray;
					data[i+1]=gray;
					data[i+2]=gray;
				}
				ctx.putImageData(imageData, 0, 0);
			}
			
			applyFilter2(){
				const canvas=this.canvas;
				const ctx=canvas.getContext("2d");
				const imageData=ctx.getImageData(0,0,canvas.width,canvas.height);
				const data = imageData.data;
				for (let i=0;i<data.length;i+=4){
					const red=data[i];
					const green=data[i+1];
					const blue=data[i+2];
					data[i]=255-red;
					data[i+1]=255-green;
					data[i+2]=255-blue;
				}
				ctx.putImageData(imageData, 0, 0);
			}
				
		}
		setTimeout(function(){
			$(document).ready(function(){
				
				const fileInput=document.getElementById("fileInput");
				const originalCanvas=document.getElementById("original");
				const filterCanvas=document.getElementById("filter");
				const originalCtx = originalCanvas.getContext("2d");
				const filterCtx = filterCanvas.getContext("2d");
				
				fileInput.addEventListener("change",function(e){
					helper.handleFileSelect().then(function(r){
						originalCtx.clearRect(0, 0, r.canvas.width, r.canvas.height);
						filterCtx.clearRect(0, 0, r.canvas.width, r.canvas.height);
						const img = new Image();
						img.src = r.img.src;
						img.onload = function(){
							originalCtx.drawImage(img, 0, 0, originalCanvas.width, originalCanvas.height);
							filterCtx.drawImage(img, 0, 0, originalCanvas.width, originalCanvas.height);
						};
						const filter=new Filter({"canvas":filterCanvas});
						const btnApplyFilterGrayScale=document.getElementById("applyGrayScale");
						const btnApplyFilter2=document.getElementById("applyFilter2");
						btnApplyFilterGrayScale.addEventListener("click",function(){
							console.log(filter.applyGrayScaleFilter());
						});
						btnApplyFilter2.addEventListener("click",function(){
							console.log(filter.applyFilter2());
						});
					});
				},false);
			});
		},2000);
	</script>
</body>
</html>
